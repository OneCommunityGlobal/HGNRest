name: Node.js CI

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]

jobs:
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js 20.17.0
      uses: actions/setup-node@v4
      with:
        node-version: 20.17.0
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run lint
      run: npm run lint

  test:
    name: Tests with 10% Coverage Enforcement
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js 20.17.0
      uses: actions/setup-node@v4
      with:
        node-version: 20.17.0
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests with coverage enforcement
      run: npm run test:ci
      
    - name: Print detailed coverage report
      if: always()
      run: |
        echo "üìä COVERAGE ENFORCEMENT REPORT üìä"
        echo "=================================="
        echo "Minimum Required: Lines: 34%, Statements: 34%, Functions: 27%, Branches: 12%"
        echo "=================================="
        if [ -f coverage/coverage-summary.json ]; then
          node -e "
            const coverage = require('./coverage/coverage-summary.json');
            const { lines, statements, functions, branches } = coverage.total;
            
            console.log('üìà CURRENT COVERAGE:');
            console.log(\`üìÑ Lines:      \${lines.pct}% \${lines.pct >= 34 ? '‚úÖ PASS' : '‚ùå FAIL'}\`);
            console.log(\`üìù Statements: \${statements.pct}% \${statements.pct >= 34 ? '‚úÖ PASS' : '‚ùå FAIL'}\`);
            console.log(\`üîß Functions:  \${functions.pct}% \${functions.pct >= 27 ? '‚úÖ PASS' : '‚ùå FAIL'}\`);
            console.log(\`üåø Branches:   \${branches.pct}% \${branches.pct >= 12 ? '‚úÖ PASS' : '‚ùå FAIL'}\`);
            
            const allPass = [lines, statements, functions, branches].every(metric => metric.pct >= 60);
            console.log('================================');
            console.log(\`üéØ OVERALL: \${allPass ? '‚úÖ COVERAGE REQUIREMENTS MET' : '‚ùå COVERAGE REQUIREMENTS FAILED'}\`);
            console.log('================================');
          "
        else
          echo "‚ùå No coverage report generated"
        fi
        
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage-report
        path: coverage/

    - run: npm ci

    # ‚úÖ Installing required native dependencies for sharp
    - name: Install libvips (sharp dependency)
      run: sudo apt-get update && sudo apt-get install -y libvips-dev

    # ‚úÖ Installing dependencies including optional ones
    - name: Install dependencies
      run: npm install --include=optional

    # ‚úÖ Rebuilding sharp for Linux
    - name: Rebuild sharp for linux
      run: npm rebuild sharp --force

    - name: Run email sender check
      run: node src/utilities/debugEmailSender.js

    - run: npm run test
    
  